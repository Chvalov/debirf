#!/bin/sh -e

# build-debirf-kernel: script to build debianized linux kernel package with 
#                      the inittmpfs patch from Kent Robotti
#
# The debirf scripts were written by
# Jameson Rollins <jrollins@fifthhorseman.net>
# and
# Daniel Kahn Gillmor <dkg-debian.org@fifthhorseman.net>.
#
# They are Copyright 2007, and are all released under the GPL, version 2
# or later.

CMD=$(basename $0)

BUILDDIR=${BUILDDIR:-~/src/linux}
KVERS=$(uname -r | cut -f1 -d-)
KAPPEND=$(uname -r | cut -f1 -d- --complement)
PKGREV=${KVERS}-${1:-1}

usage() {
cat <<EOF
usage: $CMD [N]
N is package revision number (defaults to 1)

Build a kernel for debirf.

'man build-debirf-kernel' for more information.
EOF
}

die() {
    echo "$1" >&2
    exit $2
}

# check for the proper packages:
if (! dpkg -l "linux-source-$KVERS" kernel-package fakeroot linux-patch-inittmpfs >/dev/null ); then
    die "Not continuing until you have the right packages installed." 1
fi

# create a build directory
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
tar xjf "/usr/src/linux-source-$KVERS.tar.bz2"
cd "linux-source-$KVERS"

# copy in your current config file:
cp "/boot/config-${KVERS}-${KAPPEND}" .config
# pre-answer "y" to "Unpack the early userspace onto tmpfs":
echo 'CONFIG_EARLYUSERSPACE_ON_TMPFS=y' >> .config
make-kpkg --rootcmd fakeroot --initrd --append_to_version "-${KAPPEND}+inittmpfs" --revision "$PKGREV" --added_patches inittmpfs kernel_image

# now you should have a .deb in
# $BUILDDIR/linux-image-${KVERS}-${KAPPEND}_${PKGREV}_*.deb
