#!/bin/bash

METHOD=0
#http_proxy=http://proxy.lair.fifthhorseman.net:3128/

cd /srv/debirf

# create debootstrap rot
# start by fetching initramfs-tools because they'll be handy
/usr/sbin/debootstrap --exclude=aptitude --include=initramfs-tools etch ./root/ http://ftp.debian.org/debian

# add system name
echo debirf > root/etc/hostname

# kernel install settings
cat >root/etc/kernel-img.conf <<EOF
# debirf: default kernel-img options:
do_symlinks = yes
do_bootloader = no
do_initrd = yes
EOF

# add serial terminal (plugin?)
cat >>root/etc/inittab <<EOF
# debirf: added serial console output:
T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100
EOF

# add default interface configuration (plugin?)
cat >>root/etc/network/interfaces <<EOF
# debirf: some needed interfaces:
auto lo
iface lo inet loopback

# a default dynamic ethernet address.
# if you have eth0, you can use this with "ifup eth0=dhcp"
iface dhcp inet dhcp
EOF

# mount sys, proc
mount -t proc proc root/proc
mount -t sysfs sys root/sys

# set $KERNEL_PACKAGE to the path to a kernel .deb if you have one
# lying around:
if [ "$KERNEL_PACKAGE" ]; then
    KNAME=$(basename "$KERNEL_PACKAGE")
    cp "$KERNEL_PACKAGE" "root/root/$KNAME"
    chroot root dpkg --install "root/$KNAME"
else
    chroot root apt-get update
    chroot root apt-get install linux-image-2.6-486
fi

# clean apt?
if false ; then
    chroot root apt-get clean
    rm root/var/cache/apt/*.bin
    rm -rf root/var/lib/apt/lists/*
    mkdir root/var/lib/apt/lists/partial
fi

# umount sys,proc
umount root/proc
umount root/sys

mkdir -p extras/boot

# extract kernel, debian stock initrd
mv root/boot/vmlinuz-* .
mv root/boot/initrd.img-* extras/boot/

# remove/backup locales:
mkdir -p extras/usr/share/locale
(cd root && find usr/share/locale -maxdepth 1 -mindepth 1 -type d ! -iname 'en*' -exec mv '{}' '../extras/{}' \; )

###### stupid simple method
if [ "$METHOD" = 0 ] ; then
    # clear mtab
    > root/etc/mtab
    # add proc to fstab
    echo proc /proc proc defaults 0 0 >> root/etc/fstab
    #ln sbin/init to /init
    ln -s sbin/init root/init
    # create root image
    (cd root && find * | cpio -H newc --create  | gzip ) > debirf.cgz
fi

###### tweak initrd method
if [ "$METHOD" = 1 ] ; then
    cat scripts/debirf <<EOF
mountroot() {
 rootmnt="/"
}
EOF
    cat > bin/run-init <<EOF
#!/bin/sh
if [ "$1" != "/" ] ; then
  exec /usr/lib/klibc/bin/run-init "$@"
else
  MOUNT_POINT="$1"
  INIT="$2"
  shift 2
  exec "$INIT" "$@"
fi
EOF
    # create root image
    cp extra/boot/initrd.img-* debirf.cgz
    (cd root && find * | cpio -H newc --create  | gzip ) >> debirf.cgz
fi
